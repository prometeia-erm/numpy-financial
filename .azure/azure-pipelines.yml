# Python CI/CD pipeline for a Python package

# Scheduled triggers
## - Nightly full tests are run every night on the develop branch and on release and hotfix branches to ensure the stability of the codebase.
## - Weekly security scans are run on the master, main, and support branches to check for vulnerabilities.
schedules:
  - cron: "00 0 * * 1-5"
    displayName: "Nightly Full Tests" # Run full tests every night
    branches:
      include:
        - release/*
        - hotfix/*
        - develop
    always: false

  - cron: "00 1 * * 1-5"
    displayName: "Nightly Security Scan" # Run checkmarx scan every night to check for vulnerabilities
    branches:
      include:
        - master
        - main
        - support/*
    always: true

# Trigger on branches and tags
## - The pipeline is triggered on all branches and tags that follow the Gitflow branching model.
## - Pull requests are triggered on all development and release branches, except for experimental features.
trigger:
  batch: true
  branches:
    include:
      - develop
      - feature/*
      - release/*
      - hotfix/*
      - master
      - main
      - support/*
  tags:
    include:
      - "v*"

pr:
  branches:
    include:
      - develop
      - feature/*
      - release/*
      - hotfix/*
    exclude:
      - features/experimental/*

# Define the resources that are available to the pipeline (e.g. repositories, service connections, etc.)
resources:
  repositories:
    - repository: TemplatesRepository
      type: github
      endpoint: GitHubConnection
      name: prometeia-erm/mp_azure_templates
      ref: feature/mp-ppl
  # Define a container service for each service that needs to be available during the pipeline execution (e.g. databases, caches, etc.)
  containers:
    - container: mongodb
      image: mongo:6.0
      ports:
        - 27017:27017
    - container: azurite
      image: mcr.microsoft.com/azure-storage/azurite
      ports:
        - 10000:10000
        - 10001:10001
        - 10002:10002
    - container: minio
      image: minio/minio
      ports:
        - 9000:9000
      environment:
        MINIO_ACCESS_KEY: minio
        MINIO_SECRET_KEY: minio123

# Parameters to be used in the pipeline
parameters:
  # Checkmarx parameters
  - name: forceCheckmarxScan
    displayName: "Force Checkmarx scan"
    type: boolean
    default: false
  # Python parameters
  - name: poetryForceUpdateDependencies
    displayName: "Force poetry to update dependencies"
    type: boolean
    default: false
  - name: testsType
    displayName: Run pytest tests
    type: string
    default: "fast"
    values:
      - "fast"
      - "slow"
      - "skip"
  - name: forcePublishPythonPackage
    displayName: "Force publish Python package"
    type: boolean
    default: true

# Define the variables that are used in the pipeline
variables:
  # App specific
  app: numpy-financial
  package: numpy-financial
  dependencies: ""
  sourceRepositories: "prometeia"
  publishRepositories: "prometeia"

  # Python and Poetry versions
  pythonVersion: "3.11"
  poetryVersion: "2.1.2"
  

# Define the pipeline
stages:
  - stage: build_test_publish
    displayName: "Build, test and publish"
    variables:
      - template: variables/branch-gitflow-variables.yaml@TemplatesRepository
      - template: variables/mp-service-connections.yaml@TemplatesRepository
      - template: variables/mp-build-common-variables.yaml@TemplatesRepository
        parameters:
          app: ${{ variables.app }}
      - ${{ if eq(variables['Build.Reason'], 'Schedule') }}:
          - template: variables/mp-build-cron-variables.yaml@TemplatesRepository
            parameters:
              cronSchedule: ${{ variables['Build.CronSchedule.DisplayName'] }}
      - ${{ else }}:
          - template: variables/mp-build-ci-variables.yaml@TemplatesRepository
            parameters:
              testType: ${{ parameters.testsType }}
              forcePublishPythonPackage: ${{ parameters.forcePublishPythonPackage }}
              forceCheckmarxScan: ${{ parameters.forceCheckmarxScan }}
      - group: erm-mp-pypi-secrets
      - group: erm-mp-pypi-legacy-secrets
      - group: pypi-secrets
      - group: external-services
    jobs:
      - ${{ if eq(variables['runSecurityJob'], true) }}:
          - job: checkmarx_scan
            displayName: "CheckmarX scan"
            pool:
              vmImage: $(vmImage)
            steps:
              - checkout: self
                fetchDepth: 1
                fetchTags: false
              - checkout: TemplatesRepository
              - template: templates/poetry/setup-poetry/template.yaml@TemplatesRepository
                parameters:
                  poetryVersion: $(poetryVersion)
                  pythonVersion: $(pythonVersion)
              - script: |
                  SIMPLE_REPO_URL="$(pypiUrlWithAuth)"
                  SIMPLE_REPO_URL="${SIMPLE_REPO_URL%/}"
                  if [[ "$SIMPLE_REPO_URL" != */simple ]]; then
                    SIMPLE_REPO_URL="${SIMPLE_REPO_URL}/simple"
                  fi
                  SIMPLE_REPO_URL="${SIMPLE_REPO_URL}/"
                  echo "##vso[task.setvariable variable=prometeia.name]prometeia"
                  echo "##vso[task.setvariable variable=prometeia.url]$SIMPLE_REPO_URL"
                  echo "##vso[task.setvariable variable=prometeia.username]$(pypiUsername)"
                  echo "##vso[task.setvariable variable=prometeia.password]$(pypiToken)"
                displayName: "Map repository variables for Poetry auth"
              - template: templates/poetry/setup-authentication/template.yaml@TemplatesRepository
                parameters:
                  repositories: ${{ variables.sourceRepositories }}
                  mode: source
                  workingDir: $(projectDir)
              - template: templates/checkmarx/scan/template.yaml@TemplatesRepository
                parameters:
                  checkmarxSC: ${{Â variables.checkmarxServiceConnection }}
                  projectDir: $(projectDir)
      - job: get_version
        displayName: "Get version from pyproject.toml"
        pool:
          vmImage: $(vmImage)
        variables:
          - name: BUILD_NUMBER
            value: $[counter(variables['Build.SourceBranchName'], 1)]
        steps:
          - checkout: self
            fetchDepth: 1
            fetchTags: false
          - checkout: TemplatesRepository
          - template: templates/poetry/get-version/template.yaml@TemplatesRepository
            parameters:
              buildNumber: $(BUILD_NUMBER)
              updateBuildNumber: false
              projectDir: $(projectDir)
      - ${{ if eq(variables['runPoetryJob'], true) }}:
          - job: nox_matrix_tests
            displayName: "Nox matrix tests (py 3.11/3.13)"
            pool:
              vmImage: $(vmImage)
            strategy:
              matrix:
                py311_np1:
                  pythonVersion: "3.11"
                  noxSession: "tests_py311_np1"
                py311_np2:
                  pythonVersion: "3.11"
                  noxSession: "tests_py311_np2"
                py313_np2:
                  pythonVersion: "3.13"
                  noxSession: "tests_py313_np2"
            services:
              mongodb: mongodb
            steps:
              - checkout: self
                fetchDepth: 0
                persistCredentials: true
              - checkout: TemplatesRepository
              - template: templates/poetry/setup-poetry/template.yaml@TemplatesRepository
                parameters:
                  poetryVersion: $(poetryVersion)
                  pythonVersion: $(pythonVersion)
              - script: |
                  SIMPLE_REPO_URL="$(pypiUrlWithAuth)"
                  SIMPLE_REPO_URL="${SIMPLE_REPO_URL%/}"
                  if [[ "$SIMPLE_REPO_URL" != */simple ]]; then
                    SIMPLE_REPO_URL="${SIMPLE_REPO_URL}/simple"
                  fi
                  SIMPLE_REPO_URL="${SIMPLE_REPO_URL}/"
                  echo "##vso[task.setvariable variable=prometeia.name]prometeia"
                  echo "##vso[task.setvariable variable=prometeia.url]$SIMPLE_REPO_URL"
                  echo "##vso[task.setvariable variable=prometeia.username]$(pypiUsername)"
                  echo "##vso[task.setvariable variable=prometeia.password]$(pypiToken)"
                displayName: "Map repository variables for Poetry auth"
              - template: templates/poetry/setup-authentication/template.yaml@TemplatesRepository
                parameters:
                  repositories: ${{ variables.sourceRepositories }}
                  mode: source
                  workingDir: $(projectDir)
              - script: |
                  poetry install --with dev
                  poetry run nox -s $(noxSession)
                displayName: "Run Nox session $(noxSession)"
                workingDirectory: $(projectDir)
                env:
                  NOX_PYTHON_VERSION: "$(pythonVersion)"
                  TEST_DB_URI: mongodb://localhost:27017
          - job: poetry_test_build_publish
            displayName: "Poetry test, build and publish"
            pool:
              vmImage: $(vmImage)
            dependsOn:
              - get_version
            variables:
              - name: PACKAGE_VERSION
                value: $[dependencies.get_version.outputs['get_package_version.PACKAGE_VERSION']]
            services:
              mongodb: mongodb
            steps:
              - checkout: self
                fetchDepth: 0
                persistCredentials: true
              - checkout: TemplatesRepository
              - template: templates/poetry/setup-poetry/template.yaml@TemplatesRepository
                parameters:
                  pythonVersion: $(pythonVersion)
                  poetryVersion: $(poetryVersion)
              - script: |
                  SIMPLE_REPO_URL="$(pypiUrlWithAuth)"
                  SIMPLE_REPO_URL="${SIMPLE_REPO_URL%/}"
                  if [[ "$SIMPLE_REPO_URL" != */simple ]]; then
                    SIMPLE_REPO_URL="${SIMPLE_REPO_URL}/simple"
                  fi
                  SIMPLE_REPO_URL="${SIMPLE_REPO_URL}/"
                  echo "##vso[task.setvariable variable=prometeia.name]prometeia"
                  echo "##vso[task.setvariable variable=prometeia.url]$SIMPLE_REPO_URL"
                  echo "##vso[task.setvariable variable=prometeia.username]$(pypiUsername)"
                  echo "##vso[task.setvariable variable=prometeia.password]$(pypiToken)"
                displayName: "Map repository variables for Poetry auth"
              - template: templates/poetry/setup-authentication/template.yaml@TemplatesRepository
                parameters:
                  repositories: ${{ variables.sourceRepositories }}
                  mode: source
                  workingDir: $(projectDir)
              - template: templates/poetry/setup-authentication/template.yaml@TemplatesRepository
                parameters:
                  repositories: ${{ variables.publishRepositories }}
                  mode: target
                  workingDir: $(projectDir)
              - template: templates/poetry/build-and-publish/template.yaml@TemplatesRepository
                parameters:
                  version: $(PACKAGE_VERSION)
                  repositories: ${{ variables.publishRepositories }}
                  publish: ${{ variables.publishPythonPackage }}
                  workingDir: $(projectDir)
